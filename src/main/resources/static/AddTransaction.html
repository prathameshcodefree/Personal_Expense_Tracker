<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Manager</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.2/base64.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

    <div class="container mt-5">
        <!-- Login Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title">Login</h5>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </div>
        </div>

        <!-- Transaction Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Add Transaction</h5>
            </div>
            <div class="card-body">
                <form id="transactionForm">
                    <div class="form-group">
                        <label for="description">Description</label>
                        <input type="text" id="description" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" id="amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select id="type" class="form-control" required>
                            <option value="EXPENSE">Expense</option>
                            <option value="INCOME">Income</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Transaction</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Handle login form submission
            $('#loginForm').submit(function (event) {
                event.preventDefault();

                var username = $('#username').val();
                var password = $('#password').val();

                $.ajax({
                    url: 'http://localhost:8080/auth/login',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ username: username, password: password }),
                    success: function (response) {
                        var token = response.token;
                        localStorage.setItem('jwtToken', token);

                        var userId = getUserIdFromToken(token);
                        localStorage.setItem('userId', userId);

                        console.log('Login successful, user ID:', userId);
                        // Optionally redirect or update UI after successful login
                    },
                    error: function (xhr, status, error) {
                        console.error('Login error:', error);
                    }
                });
            });

            // Handle transaction form submission
            $('#transactionForm').submit(function (event) {
                event.preventDefault();

                var description = $('#description').val();
                var amount = parseFloat($('#amount').val());
                var type = $('#type').val();
                var userId = localStorage.getItem('userId');
                var token = localStorage.getItem('jwtToken');

                if (!token || !userId) {
                    console.error('User is not logged in');
                    return;
                }

                var transactionData = {
                    description: description,
                    amount: amount,
                    type: type,
                    user: { id: userId }
                };

                $.ajax({
                    url: 'http://localhost:8080/transactions/',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: { 'Authorization': 'Bearer ' + token },
                    data: JSON.stringify(transactionData),
                    success: function (response) {
                        console.log('Transaction added successfully:', response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error adding transaction:', error);
                    }
                });
            });

            // Function to decode JWT token and extract user ID
            function getUserIdFromToken(token) {
                var payload = JSON.parse(atob(token.split('.')[1]));
                return payload.userId; // Adjust the key as per your token's payload
            }
        });
    </script>
</body>

</html>
